<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>thomasbach.dev - Create and Publish a Website with Hakyll, HAProxy and NixOS</title>
        <link rel="stylesheet" href="../css/default.css" />
        <link rel="stylesheet" href="../css/syntax.css" />
    </head>
    <body>
        <header>
            <nav>
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </nav>
        </header>

        <main role="main">
            <h1>Create and Publish a Website with Hakyll, HAProxy and NixOS</h1>
            <article>
    <section class="header">
        Posted on April  3, 2020
        
    </section>
    <section>
        <p><a href="https://jaspervdj.be/hakyll/">Hakyll</a> is a static site generator written in Haskell. This tutorial
will give you first a summary on how to generate the base Hakyll site,
second I will show you how to connect it with Nix and NixOS and in a
last step we serve all of this via HAProxy.</p>
<h2 id="initialize-the-project">Initialize the Project</h2>
<p>First, of course, we have to initialize our project. In this case I
created a repository named <code>website</code> on GitHub, cloned the empty
repository and started from there. You need to have <code>hakyll</code>
installed in order to have the <code>hakyll-init</code> command available.</p>
<pre class="example"><code>$ git clone git@github.com:thomasbach-dev/website.git
$ cd website
$ hakyll-init .
$ git add .
$ git commit -m 'initialized hakyll via hakyll-init'
</code></pre>
<p>Next, I generate <code>website.nix</code> (rename it to your projects name):</p>
<pre class="example"><code>$ cabal2nix . &gt; website.nix
</code></pre>
<p>We reference that file in our <code>shell.nix</code>:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">nixpkgs</span> <span class="op">?</span> <span class="bu">import</span> &lt;nixpkgs&gt; <span class="op">{},</span> <span class="va">compiler</span> <span class="op">?</span> <span class="st">&quot;default&quot;</span> <span class="op">}</span>:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">inherit</span> (<span class="va">nixpkgs</span>) <span class="va">pkgs</span>;</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">haskellPackages</span> <span class="op">=</span> <span class="kw">if</span> compiler == <span class="st">&quot;default&quot;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">then</span> pkgs.haskellPackages</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">else</span> pkgs.haskell.packages.$<span class="op">{</span><span class="va">compiler</span><span class="op">};</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>  <span class="va">drv</span> <span class="op">=</span> haskellPackages.callPackage <span class="ss">./website.nix</span> <span class="op">{</span> <span class="op">};</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span> pkgs.lib.inNixShell <span class="kw">then</span> drv.env <span class="kw">else</span> drv</span></code></pre></div>
<p>Now we can jump into a <code>nix-shell</code> and run the site generator
called <code>site</code> for the first time:</p>
<pre><code>$ nix-shell
$ cabal new-run site
# [Compilation output]
Missing: COMMAND

Usage: site [-v|--verbose] COMMAND
  site - Static site compiler created with Hakyll

Available options:
  -h,--help                Show this help text
  -v,--verbose             Run in verbose mode

Available commands:
  build                    Generate the site
  check                    Validate the site output
  clean                    Clean up and remove cache
  deploy                   Upload/deploy your site
  preview                  [DEPRECATED] Please use the watch command
  rebuild                  Clean and build again
  server                   Start a preview server
  watch                    Autocompile on changes and start a preview server.
                           You can watch and recompile without running a server
                           with --no-server.
</code></pre>
<p>So, let’s give it a <code>COMMAND</code>:</p>
<pre class="example"><code>$ cabal new-run site -- watch
</code></pre>
<p>This will build your site and watch for changes –everytime a file
changes it will rebuild the site. Additionally, it starts a server
which provides the site. Start up your browser of choice and guide
it to <a href="http://127.0.0.1:8000">http://127.0.0.1:8000</a>.</p>
<p>Start producing content, adapting the default templates, etc.…</p>
<h2 id="define-a-nix-derivation-and-plug-it-into-nixos">Define a nix derivation and plug it into NixOS</h2>
<p>The next step will be to produce a derivation which nix can build
for us. Add a file <code>default.nix</code> with the following content,
adapted to your needs of course:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span> <span class="va">nixpkgs</span> <span class="op">?</span> <span class="bu">import</span> &lt;nixpkgs&gt; <span class="op">{},</span> <span class="va">compiler</span> <span class="op">?</span> <span class="st">&quot;default&quot;</span><span class="op">}</span>:</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">inherit</span> (<span class="va">nixpkgs</span>) <span class="va">pkgs</span>;</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">haskellPackages</span> <span class="op">=</span> <span class="kw">if</span> compiler == <span class="st">&quot;default&quot;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>                       <span class="kw">then</span> pkgs.haskellPackages</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>                       <span class="kw">else</span> pkgs.haskell.packages.$<span class="op">{</span><span class="va">compiler</span><span class="op">};</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="va">website</span> <span class="op">=</span> haskellPackages.callPackage <span class="ss">./website.nix</span> <span class="op">{};</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="kw">in</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>nixpkgs.stdenv.mkDerivation <span class="op">{</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="va">name</span> <span class="op">=</span> <span class="st">&quot;thomas-bach.dev-website&quot;</span><span class="op">;</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="va">buildInputs</span> <span class="op">=</span> <span class="op">[</span> website <span class="op">];</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="va">src</span> <span class="op">=</span> <span class="ss">./.</span><span class="op">;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="va">buildPhase</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="st">    site build</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="st">    ''</span><span class="op">;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="va">installPhase</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="st">    mkdir $out</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a><span class="st">    cp -R _site/* $out</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="st">    ''</span><span class="op">;</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>This instructs nix to first build the Haskell executable of the
package called <code>site</code>, then, in the build phase, to call that
executable with the command <code>build</code> and finally, in the install
phase, to copy the generated files into the store. With this file
in place you can run <code>nix build</code> in the directory and you should
get a symbolic link <code>result</code> pointing to the nix store containing
only the static website.</p>
<p>Now, to make this usable to NixOS we first need a place where it
can fetch the sources from. In my case I want this to be GitHub as
I will publish the code there anyway. To make this a bit more
easier I tag the commit, I want to publish with.</p>
<pre class="example"><code>$ git tag 1
$ git push --tags
$ nix-prefetch-url --unpack https://github.com/thomasbach-dev/website/archive/1.tar.gz
0df3j462103p8hzsa08pjfk5idipwg7nfgam1am4vyjk2q45ywlg
</code></pre>
<p>In your <code>configuration.nix</code> you can now define a package -e.g. in a
let-expression- like this:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>thomasbach<span class="op">-</span>dev = <span class="bu">import</span> <span class="op">(</span>pkgs.fetchFromGitHub <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="va">owner</span> <span class="op">=</span> <span class="st">&quot;thomasbach-dev&quot;</span><span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="va">repo</span> <span class="op">=</span> <span class="st">&quot;website&quot;</span><span class="op">;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="va">rev</span> <span class="op">=</span> <span class="st">&quot;1&quot;</span><span class="op">;</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="va">sha256</span> <span class="op">=</span> <span class="st">&quot;0df3j462103p8hzsa08pjfk5idipwg7nfgam1am4vyjk2q45ywlg&quot;</span><span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="op">})</span> <span class="op">{</span> <span class="va">nixpkgs</span> <span class="op">=</span> pkgs<span class="op">;</span> <span class="op">}</span>;</span></code></pre></div>
<p>and add that package to your <code>environment.systemPackages</code> list. In
my case this gives me a store entry with the suffix
<code>thomas-bach.dev-website</code> which contains just the static files of
the site.</p>
<h2 id="serve-it-with-haproxy">Serve it with HAProxy</h2>
<p>Let’s plug this into HAProxy as a final step! As HAProxy is
basically just a proxy, we need <a href="https://discourse.haproxy.org/t/how-do-i-serve-a-single-static-file-from-haproxy/32/11">a little trick</a> to make it serve
static files: we define a LUA function which does the job for
us.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode nix"><code class="sourceCode nix"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="op">{</span><span class="va">config</span><span class="op">,</span> <span class="va">pkgs</span><span class="op">,</span> <span class="op">...}</span>:</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>      <span class="co"># https://discourse.haproxy.org/t/how-do-i-serve-a-single-static-file-from-haproxy/32/11</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>      <span class="va">serveFile</span> <span class="op">=</span> <span class="bu">builtins</span>.toFile <span class="st">&quot;serve-file.lua&quot;</span> <span class="st">''</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="st">        core.register_service(&quot;serve-file&quot;, &quot;http&quot;, function(applet)</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="st">          local docroot</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="st">          local location</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="st">          local file</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a><span class="st">          local retval</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="st">          local response</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a><span class="st">          local extension</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a><span class="st">          if(applet.path == nil or applet.headers[&quot;x-lua-loadfile-docroot&quot;] == nil or applet.headers[&quot;x-lua-loadfile-docroot&quot;][0] == &quot;&quot;) then</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="st">            retval = 500</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="st">            response = &quot;Internal Server Error&quot;</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="st">          else</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a><span class="st">            docroot = applet.headers[&quot;x-lua-loadfile-docroot&quot;][0]</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="st">            location = applet.path</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="st">            if(location == &quot;&quot; or location == &quot;/&quot;) then</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a><span class="st">              location = &quot;/index.html&quot;</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="st">            end</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="st">            file = io.open(docroot .. location, &quot;r&quot;)</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a><span class="st">            if(file == nil) then</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a><span class="st">              retval = 404</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a><span class="st">              response = &quot;File Not Found&quot;</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a><span class="st">            else</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a><span class="st">              retval = 200</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="st">              response = file:read(&quot;*all&quot;)</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a><span class="st">              file:close()</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="st">            end</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a><span class="st">          end</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a><span class="st">          extension = string.match(location, &quot;.(%w+)$&quot;)</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="st">          if       extension == &quot;css&quot;  then applet:add_header(&quot;content-type&quot;, &quot;text/css&quot;)</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a><span class="st">            elseif extension == &quot;gif&quot;  then applet:add_header(&quot;content-type&quot;, &quot;image/gif&quot;)</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a><span class="st">            elseif extension == &quot;htm&quot;  then applet:add_header(&quot;content-type&quot;, &quot;text/html&quot;)</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a><span class="st">            elseif extension == &quot;html&quot; then applet:add_header(&quot;content-type&quot;, &quot;text/html&quot;)</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a><span class="st">            elseif extension == &quot;ico&quot;  then applet:add_header(&quot;content-type&quot;, &quot;image/x-icon&quot;)</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a><span class="st">            elseif extension == &quot;jpg&quot;  then applet:add_header(&quot;content-type&quot;, &quot;image/jpeg&quot;)</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a><span class="st">            elseif extension == &quot;jpeg&quot; then applet:add_header(&quot;content-type&quot;, &quot;image/jpeg&quot;)</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a><span class="st">            elseif extension == &quot;js&quot;   then applet:add_header(&quot;content-type&quot;, &quot;application/javascript; charset=UTF-8&quot;)</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a><span class="st">            elseif extension == &quot;json&quot; then applet:add_header(&quot;content-type&quot;, &quot;application/json&quot;)</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a><span class="st">            elseif extension == &quot;mpeg&quot; then applet:add_header(&quot;content-type&quot;, &quot;video/mpeg&quot;)</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a><span class="st">            elseif extension == &quot;png&quot;  then applet:add_header(&quot;content-type&quot;, &quot;image/png&quot;)</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a><span class="st">            elseif extension == &quot;txt&quot;  then applet:add_header(&quot;content-type&quot;, &quot;text/plain&quot;)</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a><span class="st">            elseif extension == &quot;xml&quot;  then applet:add_header(&quot;content-type&quot;, &quot;application/xml&quot;)</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a><span class="st">            elseif extension == &quot;zip&quot;  then applet:add_header(&quot;content-type&quot;, &quot;application/zip&quot;)</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a><span class="st">          end</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="st">          applet:set_status(retval)</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a><span class="st">          if(response ~= nil and response ~= &quot;&quot;) then</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a><span class="st">            applet:add_header(&quot;content-length&quot;, string.len(response))</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a><span class="st">          end</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a><span class="st">          applet:start_response()</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a><span class="st">          applet:send(response)</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a><span class="st">        end)</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a><span class="st">        ''</span><span class="op">;</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>      <span class="va">thomasbach-dev</span> <span class="op">=</span> <span class="bu">import</span> <span class="op">(</span>pkgs.fetchFromGitHub <span class="op">{</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>        <span class="va">owner</span> <span class="op">=</span> <span class="st">&quot;thomasbach-dev&quot;</span><span class="op">;</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        <span class="va">repo</span> <span class="op">=</span> <span class="st">&quot;website&quot;</span><span class="op">;</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        <span class="va">rev</span> <span class="op">=</span> <span class="st">&quot;1&quot;</span><span class="op">;</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>        <span class="va">sha256</span> <span class="op">=</span> <span class="st">&quot;0df3j462103p8hzsa08pjfk5idipwg7nfgam1am4vyjk2q45ywlg&quot;</span><span class="op">;</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>      <span class="op">})</span> <span class="op">{</span> <span class="va">nixpkgs</span> <span class="op">=</span> pkgs<span class="op">;</span> <span class="op">};</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    <span class="kw">in</span> <span class="op">{</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>      <span class="va">services</span>.<span class="va">haproxy</span>.<span class="va">enable</span> <span class="op">=</span> <span class="cn">true</span><span class="op">;</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>      <span class="va">systemd</span>.<span class="va">services</span>.<span class="st">&quot;copy-site&quot;</span>.<span class="va">script</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a><span class="st">        rm -rf /var/lib/haproxy/thomasbach-dev</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a><span class="st">        cp -r </span><span class="sc">${</span>thomasbach<span class="op">-</span>dev<span class="sc">}</span><span class="st">/ /var/lib/haproxy/thomasbach-dev</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a><span class="st">        ''</span><span class="op">;</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>      <span class="va">systemd</span>.<span class="va">services</span>.<span class="va">haproxy</span>.<span class="va">requires</span> <span class="op">=</span> <span class="op">[</span> <span class="st">&quot;copy-site.service&quot;</span> <span class="op">];</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>      <span class="va">services</span>.<span class="va">haproxy</span>.<span class="va">config</span> <span class="op">=</span> <span class="st">''</span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a><span class="st">        global</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a><span class="st">          lua-load </span><span class="sc">${</span>serveFile<span class="sc">}</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a><span class="st">          chroot /var/lib/haproxy</span></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a><span class="st">          user   haproxy</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a><span class="st">          group  haproxy</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a><span class="st">        defaults</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a><span class="st">          mode http</span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a><span class="st">          option httplog</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a><span class="st">          timeout connect 5000ms</span></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a><span class="st">          timeout client  50000ms</span></span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a><span class="st">          timeout server  50000ms</span></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a><span class="st">        backend www-thomasbach-dev</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a><span class="st">          mode http</span></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a><span class="st">          http-request set-header X-LUA-LOADFILE-DOCROOT /thomasbach-dev</span></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a><span class="st">          http-request use-service lua.serve-file</span></span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a><span class="st">        frontend http-in</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a><span class="st">          bind *:80</span></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a><span class="st">          bind :::80</span></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a><span class="st">          acl thomasbach-dev hdr_beg(host) -i thomasbach.dev</span></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a><span class="st">          http-request redirect code 301 location http://www.%[hdr(host)]%[capture.req.uri] if thomasbach-dev</span></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a><span class="st">          acl www-thomasbach-dev hdr_beg(host) -i www.thomasbach.dev</span></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a><span class="st">          use_backend www-thomasbach-dev if www-thomasbach-dev</span></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a><span class="st">        ''</span><span class="op">;</span></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>;</span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Note how we reused the package definition given
above. Additionally, the configuration does a forward from
<code>http://thomasbach.dev</code> to <code>http://www.thomasbach.dev</code>. You might
not want that. Also note that as we tell HAProxy to chroot into
<code>/var/lib/haproxy</code> we cannot simply point it to the static pages in
the store. Therefor I added a little systemd-script which copies
the files over. This is far from ideal, but does the trick for now.</p>
    </section>
</article>

        </main>
    </body>
</html>
